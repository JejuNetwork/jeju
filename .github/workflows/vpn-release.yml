name: VPN Release

on:
  push:
    tags:
      - 'vpn-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      publish_stores:
        description: 'Publish to browser extension stores'
        type: boolean
        default: false

concurrency:
  group: vpn-release
  cancel-in-progress: false

env:
  APP_NAME: vpn
  WORKING_DIRECTORY: apps/vpn

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Parse version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/vpn-v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Type check
        run: cd ${{ env.WORKING_DIRECTORY }} && bun run typecheck

      - name: Run tests
        run: cd ${{ env.WORKING_DIRECTORY }} && bun test lib/ api/

  build-extensions:
    name: Build Extensions
    runs-on: ubuntu-latest
    needs: [prepare, test]
    strategy:
      matrix:
        browser: [chrome, firefox, edge]
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Update version in manifest
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          sed -i 's/"version": "[^"]*"/"version": "${{ needs.prepare.outputs.version }}"/' extension/manifest.json

      - name: Build extension
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          # Generate icons
          bun extension/scripts/generate-icons.ts
          
          # Create extension zip
          mkdir -p dist/extensions
          cd extension
          zip -r ../dist/extensions/jeju-vpn-${{ matrix.browser }}-${{ needs.prepare.outputs.version }}.zip . \
            -x "node_modules/*" \
            -x "scripts/*" \
            -x "package.json" \
            -x "*.ts"

      - name: Upload extension artifact
        uses: actions/upload-artifact@v4
        with:
          name: vpn-${{ matrix.browser }}-${{ needs.prepare.outputs.version }}
          path: ${{ env.WORKING_DIRECTORY }}/dist/extensions/jeju-vpn-${{ matrix.browser }}-${{ needs.prepare.outputs.version }}.zip

  build-lander:
    name: Build Lander
    runs-on: ubuntu-latest
    needs: [prepare, test]
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build lander and web
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: bun run build

      - name: Upload lander artifact
        uses: actions/upload-artifact@v4
        with:
          name: vpn-lander-${{ needs.prepare.outputs.version }}
          path: |
            ${{ env.WORKING_DIRECTORY }}/dist/lander/
            ${{ env.WORKING_DIRECTORY }}/dist/web/
            ${{ env.WORKING_DIRECTORY }}/dist/index.html

  build-worker:
    name: Build Worker
    runs-on: ubuntu-latest
    needs: [prepare, test]
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build worker bundle
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          mkdir -p dist/worker
          bun build api/worker.ts --outdir dist/worker --target bun --minify

      - name: Upload worker artifact
        uses: actions/upload-artifact@v4
        with:
          name: vpn-worker-${{ needs.prepare.outputs.version }}
          path: ${{ env.WORKING_DIRECTORY }}/dist/worker/

  publish-dws:
    name: Publish to DWS
    runs-on: ubuntu-latest
    needs: [prepare, build-extensions, build-lander, build-worker]
    environment: ${{ github.ref_name == 'main' && 'mainnet' || 'testnet' }}
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release directory
        run: |
          mkdir -p release/${{ needs.prepare.outputs.version }}
          
          # Copy extensions
          cp artifacts/vpn-chrome-${{ needs.prepare.outputs.version }}/*.zip release/${{ needs.prepare.outputs.version }}/
          cp artifacts/vpn-firefox-${{ needs.prepare.outputs.version }}/*.zip release/${{ needs.prepare.outputs.version }}/
          cp artifacts/vpn-edge-${{ needs.prepare.outputs.version }}/*.zip release/${{ needs.prepare.outputs.version }}/
          
          # Copy lander
          cp -r artifacts/vpn-lander-${{ needs.prepare.outputs.version }}/* release/${{ needs.prepare.outputs.version }}/
          
          # Copy worker
          cp -r artifacts/vpn-worker-${{ needs.prepare.outputs.version }}/* release/${{ needs.prepare.outputs.version }}/

      - name: Calculate checksums
        working-directory: release/${{ needs.prepare.outputs.version }}
        run: |
          for file in *.zip; do
            sha256sum "$file" | cut -d' ' -f1 > "$file.sha256"
          done

      - name: Publish to DWS
        env:
          DWS_URL: ${{ vars.DWS_URL || 'https://dws.jejunetwork.org' }}
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
        run: |
          cd release/${{ needs.prepare.outputs.version }}
          
          # Upload each extension
          CHROME_CID=""
          FIREFOX_CID=""
          EDGE_CID=""
          
          for file in *.zip; do
            echo "Uploading $file..."
            RESPONSE=$(curl -s -X POST "$DWS_URL/storage/upload" \
              -F "file=@$file" \
              -F "name=$file")
            CID=$(echo "$RESPONSE" | jq -r '.cid')
            SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
            SHA256=$(cat "$file.sha256")
            
            echo "  CID: $CID"
            
            if [[ "$file" == *"chrome"* ]]; then
              CHROME_CID="$CID"
              CHROME_SIZE="$SIZE"
              CHROME_SHA="$SHA256"
            elif [[ "$file" == *"firefox"* ]]; then
              FIREFOX_CID="$CID"
              FIREFOX_SIZE="$SIZE"
              FIREFOX_SHA="$SHA256"
            elif [[ "$file" == *"edge"* ]]; then
              EDGE_CID="$CID"
              EDGE_SIZE="$SIZE"
              EDGE_SHA="$SHA256"
            fi
          done
          
          # Create release manifest
          cat > manifest.json << EOF
          {
            "app": "vpn",
            "version": "${{ needs.prepare.outputs.version }}",
            "releasedAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "channel": "stable",
            "artifacts": [
              {
                "platform": "chrome",
                "filename": "jeju-vpn-chrome-${{ needs.prepare.outputs.version }}.zip",
                "cid": "$CHROME_CID",
                "size": $CHROME_SIZE,
                "sha256": "$CHROME_SHA"
              },
              {
                "platform": "firefox",
                "filename": "jeju-vpn-firefox-${{ needs.prepare.outputs.version }}.zip",
                "cid": "$FIREFOX_CID",
                "size": $FIREFOX_SIZE,
                "sha256": "$FIREFOX_SHA"
              },
              {
                "platform": "edge",
                "filename": "jeju-vpn-edge-${{ needs.prepare.outputs.version }}.zip",
                "cid": "$EDGE_CID",
                "size": $EDGE_SIZE,
                "sha256": "$EDGE_SHA"
              }
            ],
            "releaseNotes": "Jeju VPN v${{ needs.prepare.outputs.version }} release."
          }
          EOF
          
          # Upload manifest
          echo "Uploading manifest..."
          MANIFEST_RESPONSE=$(curl -s -X POST "$DWS_URL/storage/upload" \
            -F "file=@manifest.json" \
            -F "name=vpn-${{ needs.prepare.outputs.version }}-manifest.json")
          MANIFEST_CID=$(echo "$MANIFEST_RESPONSE" | jq -r '.cid')
          echo "Manifest CID: $MANIFEST_CID"
          
          # Update latest pointer
          echo "Updating release index..."
          curl -s -X PUT "$DWS_URL/storage/releases/vpn/latest.json" \
            -H "Content-Type: application/json" \
            -d @manifest.json
          
          echo ""
          echo "Release published successfully."
          echo "  Version: ${{ needs.prepare.outputs.version }}"
          echo "  Manifest CID: $MANIFEST_CID"

      - name: Deploy lander to CDN
        env:
          DWS_URL: ${{ vars.DWS_URL || 'https://dws.jejunetwork.org' }}
        run: |
          cd release/${{ needs.prepare.outputs.version }}
          
          # Upload lander files
          echo "Deploying lander to CDN..."
          
          for file in lander/*; do
            if [ -f "$file" ]; then
              NAME=$(basename "$file")
              curl -s -X POST "$DWS_URL/storage/upload" \
                -F "file=@$file" \
                -F "name=vpn-lander/$NAME"
            fi
          done
          
          # Configure CDN routing
          curl -s -X POST "$DWS_URL/cdn/configure" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "vpn",
              "domain": "vpn.jejunetwork.org",
              "jnsName": "vpn.jeju",
              "spa": {
                "enabled": true,
                "fallback": "/lander/index.html"
              },
              "routes": [
                { "path": "/api/*", "backend": "vpn-api" },
                { "path": "/lander", "static": "vpn-lander/index.html" },
                { "path": "/lander/*", "static": "vpn-lander/" },
                { "path": "/miniapp", "backend": "vpn-api" },
                { "path": "/miniapp/*", "backend": "vpn-api" },
                { "path": "/frame", "backend": "vpn-api" },
                { "path": "/frame/*", "backend": "vpn-api" }
              ]
            }'
          
          echo "Lander deployed."

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, build-extensions, publish-dws]
    permissions:
      contents: write
    steps:
      - name: Download extension artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: vpn-*-${{ needs.prepare.outputs.version }}

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: vpn-v${{ needs.prepare.outputs.version }}
          name: Jeju VPN v${{ needs.prepare.outputs.version }}
          draft: false
          prerelease: ${{ contains(needs.prepare.outputs.version, 'alpha') || contains(needs.prepare.outputs.version, 'beta') }}
          files: |
            artifacts/vpn-chrome-${{ needs.prepare.outputs.version }}/*.zip
            artifacts/vpn-firefox-${{ needs.prepare.outputs.version }}/*.zip
            artifacts/vpn-edge-${{ needs.prepare.outputs.version }}/*.zip
          body: |
            ## Jeju VPN v${{ needs.prepare.outputs.version }}
            
            Free, decentralized VPN powered by the community.
            
            ### Downloads
            
            | Browser | Download |
            |---------|----------|
            | **Chrome** | [jeju-vpn-chrome-${{ needs.prepare.outputs.version }}.zip](https://github.com/${{ github.repository }}/releases/download/vpn-v${{ needs.prepare.outputs.version }}/jeju-vpn-chrome-${{ needs.prepare.outputs.version }}.zip) |
            | **Firefox** | [jeju-vpn-firefox-${{ needs.prepare.outputs.version }}.zip](https://github.com/${{ github.repository }}/releases/download/vpn-v${{ needs.prepare.outputs.version }}/jeju-vpn-firefox-${{ needs.prepare.outputs.version }}.zip) |
            | **Edge** | [jeju-vpn-edge-${{ needs.prepare.outputs.version }}.zip](https://github.com/${{ github.repository }}/releases/download/vpn-v${{ needs.prepare.outputs.version }}/jeju-vpn-edge-${{ needs.prepare.outputs.version }}.zip) |
            
            ### Installation
            
            1. Download the extension for your browser
            2. Unzip the downloaded file
            3. Enable Developer Mode in your browser's extension settings
            4. Click "Load unpacked" and select the unzipped folder
            
            ### Features
            
            - Unlimited VPN access
            - Decentralized network - no central servers
            - JNS resolver - access .jeju domains
            - WebRTC protection
            - Fair contribution model
            
            ---
            
            Also available at: https://vpn.jejunetwork.org
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-chrome:
    name: Publish to Chrome Web Store
    runs-on: ubuntu-latest
    needs: [prepare, build-extensions, publish-dws]
    if: ${{ github.event_name == 'release' || inputs.publish_stores == true }}
    env:
      CHROME_EXTENSION_ID: ${{ secrets.VPN_CHROME_EXTENSION_ID }}
    steps:
      - name: Download Chrome extension
        uses: actions/download-artifact@v4
        with:
          name: vpn-chrome-${{ needs.prepare.outputs.version }}
          path: chrome-ext

      - name: Publish to Chrome Web Store
        if: ${{ env.CHROME_EXTENSION_ID != '' }}
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          file-path: chrome-ext/jeju-vpn-chrome-${{ needs.prepare.outputs.version }}.zip
          extension-id: ${{ secrets.VPN_CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          publish-target: default

  publish-firefox:
    name: Publish to Firefox Add-ons
    runs-on: ubuntu-latest
    needs: [prepare, build-extensions, publish-dws]
    if: ${{ github.event_name == 'release' || inputs.publish_stores == true }}
    env:
      FIREFOX_API_KEY: ${{ secrets.FIREFOX_API_KEY }}
    steps:
      - name: Download Firefox extension
        uses: actions/download-artifact@v4
        with:
          name: vpn-firefox-${{ needs.prepare.outputs.version }}
          path: firefox-ext

      - name: Publish to Firefox Add-ons
        if: ${{ env.FIREFOX_API_KEY != '' }}
        uses: yayuyokitano/firefox-addon@v0.0.6-alpha
        with:
          api_key: ${{ secrets.FIREFOX_API_KEY }}
          api_secret: ${{ secrets.FIREFOX_API_SECRET }}
          guid: '{jeju-vpn@jejunetwork.org}'
          xpi_path: firefox-ext/jeju-vpn-firefox-${{ needs.prepare.outputs.version }}.zip

  publish-edge:
    name: Publish to Edge Add-ons
    runs-on: ubuntu-latest
    needs: [prepare, build-extensions, publish-dws]
    if: ${{ github.event_name == 'release' || inputs.publish_stores == true }}
    env:
      EDGE_PRODUCT_ID: ${{ secrets.VPN_EDGE_PRODUCT_ID }}
    steps:
      - name: Download Edge extension
        uses: actions/download-artifact@v4
        with:
          name: vpn-edge-${{ needs.prepare.outputs.version }}
          path: edge-ext

      - name: Publish to Edge Add-ons
        if: ${{ env.EDGE_PRODUCT_ID != '' }}
        uses: nicovince/upload-edge-addon@v2
        with:
          product-id: ${{ secrets.VPN_EDGE_PRODUCT_ID }}
          client-id: ${{ secrets.EDGE_CLIENT_ID }}
          client-secret: ${{ secrets.EDGE_CLIENT_SECRET }}
          access-token-url: ${{ secrets.EDGE_ACCESS_TOKEN_URL }}
          zip: edge-ext/jeju-vpn-edge-${{ needs.prepare.outputs.version }}.zip
