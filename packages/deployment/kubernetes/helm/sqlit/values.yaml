# SQLit - Decentralized SQL Database
# Replaces AWS RDS with a decentralized, replicated SQLite cluster

replicaCount: 3

image:
  repository: registry.jeju/sqlit
  pullPolicy: IfNotPresent
  tag: "latest"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  annotations: {}
  name: ""

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "5000"
  prometheus.io/path: "/metrics"

podSecurityContext:
  fsGroup: 1000

securityContext:
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 1000

service:
  type: ClusterIP
  port: 5000
  annotations: {}

# SQLit Configuration
config:
  # Cluster configuration
  cluster:
    # Minimum nodes for quorum
    minNodes: 2
    # Replication factor
    replicationFactor: 3
    # Consensus protocol: raft or paxos
    consensusProtocol: "raft"
    # Leader election timeout
    electionTimeout: "5s"
    # Heartbeat interval
    heartbeatInterval: "500ms"

  # Database configuration
  database:
    # Maximum databases per node
    maxDatabases: 100
    # Default WAL mode for all databases
    walMode: true
    # Checkpoint interval
    checkpointInterval: "30s"
    # Page size
    pageSize: 4096
    # Cache size (pages)
    cacheSize: 10000
    # Journal mode
    journalMode: "WAL"

  # Network configuration
  network:
    # P2P port for cluster communication
    p2pPort: 5001
    # gRPC port for client connections
    grpcPort: 5002
    # HTTP port for REST API
    httpPort: 5000
    # Enable TLS
    tlsEnabled: true

  # Storage configuration
  storage:
    # Data directory
    dataDir: "/data/sqlit"
    # WAL directory
    walDir: "/data/sqlit/wal"
    # Snapshot directory
    snapshotDir: "/data/sqlit/snapshots"
    # Snapshot interval
    snapshotInterval: "1h"
    # Max snapshots to retain
    maxSnapshots: 5

  # Backup configuration
  backup:
    # Enable automatic backups
    enabled: true
    # Backup to IPFS
    ipfsEnabled: true
    # Backup interval
    interval: "6h"
    # Retention period
    retention: "7d"

  # Blockchain integration
  blockchain:
    # Jeju L2 RPC
    rpcUrl: "http://reth-sequencer.execution.svc.cluster.local:8545"
    # Chain ID
    chainId: 420691
    # DWS Provider Registry contract
    providerRegistryAddress: ""
    # Register as database provider
    registerAsProvider: true
    # Stake amount for provider registration
    stakeAmount: "5000"

# Environment variables
env:
  - name: SQLIT_LOG_LEVEL
    value: "info"
  - name: SQLIT_CLUSTER_NAME
    value: "jeju-sqlit"

# Secrets
secretEnv:
  - name: SQLIT_ENCRYPTION_KEY
    secretName: sqlit-secrets
    secretKey: encryption-key
  - name: SQLIT_PROVIDER_KEY
    secretName: sqlit-secrets
    secretKey: provider-key

# Persistence
persistence:
  enabled: true
  storageClass: "local-path"
  size: 100Gi
  accessModes:
    - ReadWriteOnce

# Resources
resources:
  limits:
    cpu: 2000m
    memory: 4Gi
  requests:
    cpu: 500m
    memory: 1Gi

# Liveness probe
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# Readiness probe
readinessProbe:
  httpGet:
    path: /ready
    port: http
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity - spread across nodes
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
                - sqlit
        topologyKey: kubernetes.io/hostname

# Metrics
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s

# Network policies
networkPolicy:
  enabled: true
  # Allow traffic from DWS namespace
  allowedNamespaces:
    - dws
    - blockscout
  # Allow traffic from specific pods
  allowedPodLabels:
    app.kubernetes.io/part-of: jeju

# Init containers for cluster bootstrap
initContainers: []

# Sidecar containers
sidecars: []
