# JNS DNS Manager
# Bridges JNS (Jeju Name Service) on-chain names to DNS resolution
# Replaces AWS Route53 with decentralized name resolution

replicaCount: 2

image:
  repository: registry.jeju/jns-dns
  pullPolicy: IfNotPresent
  tag: "latest"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  annotations: {}
  name: ""

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8053"
  prometheus.io/path: "/metrics"

# DNS Service (exposed for DNS queries)
service:
  type: LoadBalancer
  # DNS ports
  dnsPort: 53
  dnsOverHttpsPort: 443
  dnsOverTlsPort: 853
  # API port
  apiPort: 8053
  annotations:
    # For cloud providers
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"

# HTTP ingress for DoH
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
  hosts:
    - host: dns.jeju
      paths:
        - path: /dns-query
          pathType: Prefix
  tls:
    - secretName: dns-tls
      hosts:
        - dns.jeju

# JNS DNS Configuration
config:
  # DNS server configuration
  dns:
    # Upstream DNS for non-.jeju queries
    upstream:
      - "8.8.8.8:53"
      - "1.1.1.1:53"
    # Cache TTL
    cacheTtl: 300
    # Negative cache TTL
    negativeCacheTtl: 60
    # Max cache size
    maxCacheSize: 10000

  # JNS configuration
  jns:
    # JNS Registry contract
    registryAddress: "0x66ac1e36094e3cfa47258589be7bd3cef5884e97"
    # JNS Resolver contract
    resolverAddress: "0xe27b540b6fd3868ad6420c466c8330da3a6417bf"
    # Jeju L2 RPC
    rpcUrl: "http://reth-sequencer.execution.svc.cluster.local:8545"
    wsRpcUrl: "ws://reth-sequencer.execution.svc.cluster.local:8546"
    # Chain ID
    chainId: 420691
    # TLD
    tld: "jeju"
    # Sync interval (poll for changes)
    syncInterval: "10s"
    # Use WebSocket for real-time updates
    useWebSocket: true

  # DNS-over-HTTPS (DoH)
  doh:
    enabled: true
    path: "/dns-query"

  # DNS-over-TLS (DoT)
  dot:
    enabled: true

  # Zone transfer for traditional DNS servers
  zoneTransfer:
    enabled: true
    # Allowed IPs for zone transfer
    allowedIps:
      - "10.0.0.0/8"
      - "172.16.0.0/12"
      - "192.168.0.0/16"

  # DNSSEC
  dnssec:
    enabled: true
    # DNSSEC key rotation interval
    keyRotationInterval: "30d"

  # Rate limiting
  rateLimit:
    enabled: true
    requestsPerSecond: 1000
    burstSize: 2000

  # Logging
  logging:
    level: "info"
    queryLogging: true
    format: "json"

# DWS Provider integration
provider:
  enabled: true
  # Register as DNS provider in DWSProviderRegistry
  registerAsProvider: true
  # Service types
  services:
    - dns
  # Stake for provider registration
  stakeAmount: "500"

# CoreDNS configuration (for Kubernetes integration)
coredns:
  enabled: true
  # Forward .jeju queries to JNS DNS
  forwardZone: "jeju"

# Environment variables
env:
  - name: JNS_LOG_LEVEL
    value: "info"
  - name: JNS_DNS_PORT
    value: "53"
  - name: JNS_API_PORT
    value: "8053"

# Secrets
secretEnv:
  - name: JNS_DNSSEC_KEY
    secretName: jns-dns-secrets
    secretKey: dnssec-key
  - name: JNS_DOT_CERT
    secretName: jns-dns-secrets
    secretKey: dot-cert
  - name: JNS_DOT_KEY
    secretName: jns-dns-secrets
    secretKey: dot-key

# Resources
resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 250m
    memory: 256Mi

# Liveness probe
livenessProbe:
  httpGet:
    path: /health
    port: 8053
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# Readiness probe
readinessProbe:
  httpGet:
    path: /ready
    port: 8053
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - jns-dns
          topologyKey: kubernetes.io/hostname

# Metrics
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s
