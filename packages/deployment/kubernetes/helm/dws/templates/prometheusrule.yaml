{{- if .Values.metrics.enabled }}
{{- if .Values.metrics.prometheusRule.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "dws.fullname" . }}
  labels:
    {{- include "dws.labels" . | nindent 4 }}
    {{- with .Values.metrics.prometheusRule.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  groups:
    - name: dws.rules
      rules:
        # Pod not ready
        - alert: DWSPodNotReady
          expr: |
            kube_pod_status_ready{condition="true", pod=~"{{ include "dws.fullname" . }}.*"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "DWS pod not ready"
            description: "DWS pod {{ "{{" }} $labels.pod {{ "}}" }} is not ready for more than 5 minutes"

        # High memory usage (uses container_* metrics from cAdvisor)
        - alert: DWSHighMemoryUsage
          expr: |
            (
              sum(container_memory_working_set_bytes{container="{{ include "dws.fullname" . }}"}) by (pod)
              /
              sum(kube_pod_container_resource_limits{resource="memory", container="{{ include "dws.fullname" . }}"}) by (pod)
            ) > 0.9
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "DWS high memory usage"
            description: "DWS pod {{ "{{" }} $labels.pod {{ "}}" }} memory usage is above 90%"

        # High CPU usage
        - alert: DWSHighCPUUsage
          expr: |
            (
              sum(rate(container_cpu_usage_seconds_total{container="{{ include "dws.fullname" . }}"}[5m])) by (pod)
              /
              sum(kube_pod_container_resource_limits{resource="cpu", container="{{ include "dws.fullname" . }}"}) by (pod)
            ) > 0.9
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "DWS high CPU usage"
            description: "DWS pod {{ "{{" }} $labels.pod {{ "}}" }} CPU usage is above 90%"

        # Pod restart rate
        - alert: DWSHighRestartRate
          expr: |
            increase(kube_pod_container_status_restarts_total{container="{{ include "dws.fullname" . }}"}[1h]) > 3
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "DWS high restart rate"
            description: "DWS container has restarted {{ "{{" }} $value {{ "}}" }} times in the last hour"

        # Pod pending
        - alert: DWSPodPending
          expr: |
            kube_pod_status_phase{pod=~"{{ include "dws.fullname" . }}.*", phase="Pending"} == 1
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "DWS pod pending"
            description: "DWS pod {{ "{{" }} $labels.pod {{ "}}" }} has been pending for more than 10 minutes"

        # PVC usage (if persistence enabled)
        {{- if .Values.persistence.enabled }}
        - alert: DWSPVCNearFull
          expr: |
            (
              kubelet_volume_stats_used_bytes{persistentvolumeclaim=~"{{ include "dws.fullname" . }}.*"}
              /
              kubelet_volume_stats_capacity_bytes{persistentvolumeclaim=~"{{ include "dws.fullname" . }}.*"}
            ) > 0.85
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "DWS PVC nearly full"
            description: "DWS PVC {{ "{{" }} $labels.persistentvolumeclaim {{ "}}" }} is {{ "{{" }} $value | humanizePercentage {{ "}}" }} full"
        {{- end }}

        # No replicas (critical)
        - alert: DWSNoReplicas
          expr: |
            kube_deployment_status_replicas_available{deployment="{{ include "dws.fullname" . }}"} == 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "DWS has no available replicas"
            description: "DWS deployment {{ "{{" }} $labels.deployment {{ "}}" }} has 0 available replicas"

        # PoC verification metrics (if available)
        - alert: DWSPoCVerificationFailureRate
          expr: |
            (
              rate(poc_verifications_failed[5m])
              /
              (rate(poc_verifications_success[5m]) + rate(poc_verifications_failed[5m]))
            ) > 0.1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High PoC verification failure rate"
            description: "PoC verification failure rate is above 10%"
{{- end }}
{{- end }}
