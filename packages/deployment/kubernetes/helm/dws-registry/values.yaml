# DWS Container Registry
# Decentralized container registry using IPFS backend
# Replaces AWS ECR with a self-hosted, decentralized registry

replicaCount: 2

image:
  repository: registry
  pullPolicy: IfNotPresent
  tag: "2.8.3"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  annotations: {}
  name: ""

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "5000"
  prometheus.io/path: "/metrics"

service:
  type: ClusterIP
  port: 5000
  annotations: {}

ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "0"  # No limit for large images
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
  hosts:
    - host: registry.jeju
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: registry-tls
      hosts:
        - registry.jeju

# Registry configuration
config:
  # Storage backend
  storage:
    # Use IPFS as storage backend for decentralization
    backend: "ipfs"

    # IPFS configuration
    ipfs:
      apiEndpoint: "http://ipfs.dws.svc.cluster.local:5001"
      gateway: "http://ipfs.dws.svc.cluster.local:8080"
      # Pin all uploaded images
      pinImages: true
      # Replicate to Filecoin for permanent storage
      filecoinEnabled: true

    # Fallback to filesystem for local caching
    filesystem:
      rootDirectory: /var/lib/registry
      maxThreads: 100

    # Cache configuration
    cache:
      enabled: true
      blobDescriptor: "inmemory"
      layerInfo: "inmemory"

    # Delete enabled
    delete:
      enabled: true

    # Redirect to storage backend
    redirect:
      disable: true

  # HTTP configuration
  http:
    addr: ":5000"
    headers:
      X-Content-Type-Options: [nosniff]
    http2:
      disabled: false
    debug:
      addr: ":5001"
      prometheus:
        enabled: true
        path: /metrics

  # Authentication
  auth:
    # Use token-based auth with on-chain verification
    token:
      autoredirect: false
      realm: "https://registry.jeju/auth/token"
      service: "registry.jeju"
      issuer: "registry.jeju"
      # On-chain identity verification
      onChainVerification:
        enabled: true
        identityRegistryAddress: ""  # Set via values override
        rpcUrl: "http://reth-sequencer.execution.svc.cluster.local:8545"

  # Notifications - publish to blockchain
  notifications:
    endpoints:
      - name: "blockchain"
        url: "http://dws.dws.svc.cluster.local:4030/registry/webhook"
        headers:
          Authorization: ["Bearer ${REGISTRY_WEBHOOK_TOKEN}"]
        timeout: 5000
        threshold: 5
        backoff: 1000

  # Garbage collection
  gc:
    disabled: false
    # Run GC every 24 hours
    interval: "24h"

  # Health checks
  health:
    storageDriver:
      enabled: true
      interval: 10s
      threshold: 3

# Blockchain integration
blockchain:
  # Register pushed images on-chain
  onChainRegistry:
    enabled: true
    contractAddress: ""  # ContainerRegistry contract address
    rpcUrl: "http://reth-sequencer.execution.svc.cluster.local:8545"
    chainId: 420691

# Environment variables
env:
  - name: REGISTRY_LOG_LEVEL
    value: "info"
  - name: REGISTRY_STORAGE_DELETE_ENABLED
    value: "true"

# Secrets
secretEnv:
  - name: REGISTRY_HTTP_SECRET
    secretName: registry-secrets
    secretKey: http-secret
  - name: REGISTRY_AUTH_TOKEN_ROOTCERTBUNDLE
    secretName: registry-secrets
    secretKey: token-cert
  - name: REGISTRY_WEBHOOK_TOKEN
    secretName: registry-secrets
    secretKey: webhook-token
  - name: REGISTRY_OPERATOR_KEY
    secretName: registry-secrets
    secretKey: operator-key

# Persistence for local cache
persistence:
  enabled: true
  storageClass: "local-path"
  size: 100Gi
  accessModes:
    - ReadWriteOnce

# Resources
resources:
  limits:
    cpu: 2000m
    memory: 4Gi
  requests:
    cpu: 500m
    memory: 1Gi

# Liveness probe
livenessProbe:
  httpGet:
    path: /
    port: 5000
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# Readiness probe
readinessProbe:
  httpGet:
    path: /
    port: 5000
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - dws-registry
          topologyKey: kubernetes.io/hostname

# IPFS sidecar
ipfs:
  enabled: true
  image:
    repository: ipfs/kubo
    tag: "v0.27.0"
  persistence:
    size: 200Gi
    storageClass: "local-path"

# Metrics
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s
